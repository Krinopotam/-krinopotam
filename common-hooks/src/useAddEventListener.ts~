import React, {useEffect} from 'react';
import {useEvent} from './useEvent';

/**
 * Add event listener and remove it on unmount
 */
export const useAddEventListener = <K extends keyof DocumentEventMap, Target extends EventTarget, TReturn>(
    /** event name */
    name: K,
    /** event handler (don't care about function stability, handler will be wrapped by useEvent) */
    handler: (ev: DocumentEventMap[K]) => TReturn,
    /** event target (document by default) */
    target?: Target | (() => Target) | React.RefObject<Target> | null,
    /** additional event options */
    options?: boolean | AddEventListenerOptions,
    /** skip adding event listener */
    skip?: boolean
) => {
    const callback = useEvent(handler) as unknown as EventListener;

    useEffect(() => {
        if (skip) return;
        const targetElement = getTarget(target);
        targetElement.addEventListener(name, callback, options);
        return () => {
            targetElement.removeEventListener(name, callback, options);
        };
    }, [callback, name, options, target]);
};

const getTarget = <Target extends EventTarget>(target?: Target | (() => Target) | React.RefObject<Target> | null) => {
    if (target instanceof EventTarget) return target;
    if (typeof target === 'function') return target();
    if (target?.current && target instanceof EventTarget) return target.current;
    return document;
};
